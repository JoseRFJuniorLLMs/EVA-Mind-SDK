<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVA Debug Monitor - Otimizado</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a0a1f 0%, #0f1a2e 100%);
            color: #ffb3d9;
            padding: 20px;
            font-size: 14px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #b3d9ff;
            text-shadow: 0 0 20px rgba(179, 217, 255, 0.6);
        }

        .subtitle {
            text-align: center;
            color: #ffccf2;
            margin-bottom: 20px;
            font-size: 12px;
        }

        .section {
            background: linear-gradient(135deg, rgba(255, 179, 217, 0.05) 0%, rgba(179, 217, 255, 0.05) 100%);
            border: 2px solid rgba(255, 179, 217, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }

        .section-title {
            color: #ffb3d9;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        .status-indicator.active {
            background: linear-gradient(135deg, #ffb3d9, #b3d9ff);
            box-shadow: 0 0 10px rgba(255, 179, 217, 0.6);
        }

        .status-indicator.error {
            background: #ff6b9d;
            box-shadow: 0 0 10px rgba(255, 107, 157, 0.6);
        }

        .status-indicator.idle {
            background: #666;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .info-item {
            background: rgba(255, 179, 217, 0.05);
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid #ffb3d9;
        }

        .info-label {
            color: #b3b3cc;
            font-size: 11px;
            margin-bottom: 5px;
        }

        .info-value {
            color: #ffb3d9;
            font-size: 13px;
            font-weight: bold;
        }

        .info-value.warning {
            color: #ffd699;
        }

        .info-value.error {
            color: #ff6b9d;
        }

        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 179, 217, 0.2);
            border-radius: 8px;
            height: 250px;
            overflow-y: auto;
            padding: 10px;
            font-size: 11px;
        }

        .log-entry {
            margin-bottom: 3px;
            padding: 3px;
            border-radius: 3px;
        }

        .log-entry.info {
            color: #b3d9ff;
        }

        .log-entry.warning {
            color: #ffd699;
            background: rgba(255, 214, 153, 0.1);
        }

        .log-entry.error {
            color: #ff6b9d;
            background: rgba(255, 107, 157, 0.1);
        }

        .log-entry.success {
            color: #ffb3d9;
        }

        .log-time {
            color: #666;
            margin-right: 8px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(135deg, #ffb3d9, #b3d9ff);
            color: #1a0a1f;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 13px;
            box-shadow: 0 4px 15px rgba(255, 179, 217, 0.3);
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 179, 217, 0.5);
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .config-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 179, 217, 0.3);
            color: #ffb3d9;
            padding: 8px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin-top: 5px;
        }

        .config-input:focus {
            outline: none;
            border-color: #ffb3d9;
            box-shadow: 0 0 10px rgba(255, 179, 217, 0.3);
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }

        .quality-bar {
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        .quality-fill {
            height: 100%;
            background: linear-gradient(to right, #ff6b9d, #ffb3d9, #b3d9ff);
            transition: width 0.3s;
            box-shadow: 0 0 10px rgba(255, 179, 217, 0.5);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #ffb3d9, #b3d9ff);
            border-radius: 4px;
        }

        .optimization-badge {
            display: inline-block;
            background: #00ff00;
            color: #000;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üî¨ EVA DEBUG MONITOR</h1>
        <div class="subtitle">
            ‚ú® Otimizado: 24kHz | Buffer 9600 | Jitter | Float32 do Servidor
            <span class="optimization-badge">v2.1</span>
        </div>

        <div class="section">
            <div class="section-title">‚öôÔ∏è CONFIGURA√á√ÉO</div>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">CPF</div>
                    <input type="text" id="cpfInput" class="config-input" value="12345678900">
                </div>
                <div class="info-item">
                    <div class="info-label">WebSocket URL</div>
                    <input type="text" id="wsUrlInput" class="config-input"
                        value="wss://eva-mind-sdk-285161077100.europe-southwest1.run.app/ws/pcm">
                </div>
            </div>
        </div>

        <div class="controls">
            <button id="startBtn" onclick="startEVA()">‚ñ∂Ô∏è START</button>
            <button id="stopBtn" onclick="stopEVA()" disabled>‚èπÔ∏è STOP</button>
            <button onclick="clearLogs()">üóëÔ∏è Clear</button>
            <button onclick="exportLogs()">üíæ Export</button>
            <button onclick="toggleJitter()">üéöÔ∏è Toggle Jitter</button>
        </div>

        <div class="section">
            <div class="section-title">
                <span class="status-indicator" id="statusIndicator"></span>
                üìä SYSTEM STATUS
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Estado</div>
                    <div class="info-value" id="currentState">idle</div>
                </div>
                <div class="info-item">
                    <div class="info-label">WebSocket</div>
                    <div class="info-value" id="wsStatus">disconnected</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Sample Rate (Capture)</div>
                    <div class="info-value" id="captureSampleRate">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Sample Rate (Playback)</div>
                    <div class="info-value" id="playbackSampleRate">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Jitter Buffer</div>
                    <div class="info-value" id="jitterStatus">desabilitado</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Uptime</div>
                    <div class="info-value" id="uptime">0s</div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">üé§ AUDIO METRICS</div>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Pacotes Enviados</div>
                    <div class="metric-value" id="audioSent">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Pacotes Recebidos</div>
                    <div class="metric-value" id="audioReceived">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Taxa de Envio</div>
                    <div class="info-value" id="sendRate">0 pkt/s</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Taxa de Recep√ß√£o</div>
                    <div class="info-value" id="receiveRate">0 pkt/s</div>
                </div>
                <div class="info-item">
                    <div class="info-label">SNR M√©dio</div>
                    <div class="info-value" id="avgSNR">-</div>
                    <div class="quality-bar">
                        <div class="quality-fill" id="snrBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Volume M√©dio</div>
                    <div class="info-value" id="avgVolume">-</div>
                    <div class="quality-bar">
                        <div class="quality-fill" id="volumeBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">üìù EVENT LOG</div>
            <div class="log-container" id="logContainer"></div>
        </div>
    </div>

    <script>
        // ============ CONFIGURA√á√ïES OTIMIZADAS ============
        const TARGET_SAMPLE_RATE = 24000; // ‚úÖ CR√çTICO: 24kHz
        const MIN_BUFFER_SIZE = 9600;     // ‚úÖ CR√çTICO: 400ms buffer
        const JITTER_BUFFER_SIZE = 3;     // ‚úÖ 3 pacotes
        const CAPTURE_CHUNK_SIZE = 2400;  // 100ms @ 24kHz

        // Estado global
        let ws = null;
        let audioContext = null;
        let scriptProcessor = null;
        let mediaStream = null;
        let playbackContext = null;
        let isActive = false;
        let audioSentCount = 0;
        let audioReceivedCount = 0;
        let currentState = 'idle';
        let startTime = null;
        let lastSentCount = 0;
        let lastReceivedCount = 0;

        // ‚úÖ Jitter Buffer
        let jitterBuffer = [];
        let jitterBufferEnabled = true;
        let jitterBufferReady = false;

        // ‚úÖ Quality Metrics
        let snrHistory = [];
        let volumeHistory = [];

        // Playback queue
        let playbackQueue = [];
        let isPlaying = false;
        let playbackScheduledTime = 0;

        // ============ LOGGING ============
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `<span class="log-time">${time}</span>${message}`;
            const container = document.getElementById('logContainer');
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            log('Logs limpos', 'info');
        }

        function exportLogs() {
            const logs = document.getElementById('logContainer').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `eva-debug-${Date.now()}.txt`;
            a.click();
            log('Logs exportados', 'success');
        }

        function toggleJitter() {
            jitterBufferEnabled = !jitterBufferEnabled;
            jitterBuffer = [];
            jitterBufferReady = false;
            log(`Jitter Buffer: ${jitterBufferEnabled ? 'ATIVADO' : 'DESATIVADO'}`, 'info');
            updateUI();
        }

        // ============ UI UPDATES ============
        function updateUI() {
            document.getElementById('currentState').textContent = currentState;
            document.getElementById('statusIndicator').className = `status-indicator ${currentState}`;
            document.getElementById('wsStatus').textContent = ws ?
                (ws.readyState === WebSocket.OPEN ? '‚úÖ connected' : '‚ùå disconnected') : 'offline';
            document.getElementById('captureSampleRate').textContent =
                audioContext ? `${audioContext.sampleRate}Hz` : '-';
            document.getElementById('playbackSampleRate').textContent =
                playbackContext ? `${playbackContext.sampleRate}Hz` : '-';
            document.getElementById('jitterStatus').textContent =
                jitterBufferEnabled ? `‚úÖ ativo (${jitterBuffer.length}/${JITTER_BUFFER_SIZE})` : '‚ùå desabilitado';
            document.getElementById('audioSent').textContent = audioSentCount;
            document.getElementById('audioReceived').textContent = audioReceivedCount;

            // Taxas
            const sentRate = audioSentCount - lastSentCount;
            const receivedRate = audioReceivedCount - lastReceivedCount;
            document.getElementById('sendRate').textContent = `${sentRate} pkt/s`;
            document.getElementById('receiveRate').textContent = `${receivedRate} pkt/s`;
            lastSentCount = audioSentCount;
            lastReceivedCount = audioReceivedCount;

            // Quality metrics
            if (snrHistory.length > 0) {
                const avgSNR = snrHistory.reduce((a, b) => a + b, 0) / snrHistory.length;
                document.getElementById('avgSNR').textContent = `${avgSNR.toFixed(1)}%`;
                document.getElementById('avgSNR').className = avgSNR < 10 ? 'info-value error' : 'info-value';
                document.getElementById('snrBar').style.width = `${Math.min(avgSNR, 100)}%`;
            }

            if (volumeHistory.length > 0) {
                const avgVol = volumeHistory.reduce((a, b) => a + b, 0) / volumeHistory.length;
                document.getElementById('avgVolume').textContent = `${avgVol.toFixed(0)}`;
                document.getElementById('avgVolume').className = avgVol < 1000 ? 'info-value warning' : 'info-value';
                document.getElementById('volumeBar').style.width = `${Math.min(avgVol / 100, 100)}%`;
            }

            // Uptime
            if (startTime) {
                const uptime = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('uptime').textContent = `${uptime}s`;
            }
        }

        // ‚úÖ AN√ÅLISE DE QUALIDADE - ATUALIZADO PARA FLOAT32
        function analyzeAudioQuality(float32Buffer) {
            const samples = new Float32Array(float32Buffer);
            let sum = 0;
            let max = 0;

            for (let i = 0; i < samples.length; i++) {
                const abs = Math.abs(samples[i]);
                sum += abs;
                max = Math.max(max, abs);
            }

            const avg = sum / samples.length;
            const snr = max > 0 ? (avg / max) * 100 : 0;

            snrHistory.push(snr);
            volumeHistory.push(max * 32768); // Converter para escala PCM16 para compara√ß√£o
            if (snrHistory.length > 30) {
                snrHistory.shift();
                volumeHistory.shift();
            }

            if (snr < 10) {
                log(`‚ö†Ô∏è SNR baixo: ${snr.toFixed(1)}% - poss√≠vel chiado`, 'warning');
            }
            if (max < 0.03) { // 0.03 em Float32 ‚âà 1000 em PCM16
                log(`‚ö†Ô∏è Volume muito baixo: ${(max * 32768).toFixed(0)}`, 'warning');
            }
        }

        // ============ WEBSOCKET ============
        function connectWebSocket() {
            return new Promise((resolve, reject) => {
                const wsUrl = document.getElementById('wsUrlInput').value;
                log(`üîå Conectando: ${wsUrl}`, 'info');

                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    log('‚úÖ WebSocket CONECTADO!', 'success');
                    resolve();
                };

                ws.onmessage = handleWebSocketMessage;

                ws.onerror = () => {
                    log('‚ùå WebSocket ERROR', 'error');
                    reject(new Error('WebSocket error'));
                };

                ws.onclose = (event) => {
                    log(`WebSocket FECHADO: ${event.code}`, 'warning');
                    if (isActive) {
                        cleanup();
                    }
                };
            });
        }

        function handleWebSocketMessage(event) {
            if (typeof event.data === 'string') {
                try {
                    const msg = JSON.parse(event.data);
                    log(`üì® MSG: ${msg.type}`, 'info');

                    if (msg.type === 'registered') {
                        currentState = 'registered';
                    } else if (msg.type === 'session_created') {
                        currentState = 'session_created';
                    } else if (msg.type === 'error') {
                        log(`‚ùå Erro: ${msg.error}`, 'error');
                    }
                } catch (e) {
                    log(`Erro JSON: ${e.message}`, 'error');
                }
                return;
            }

            if (event.data instanceof Blob) {
                audioReceivedCount++;
                event.data.arrayBuffer().then(buffer => {
                    playAudio(buffer);
                });
            }
        }

        // ============ AUDIO CAPTURE ============
        async function initializeAudio() {
            log('üé§ Solicitando microfone...', 'info');

            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: TARGET_SAMPLE_RATE, // ‚úÖ 24kHz
                        channelCount: 1
                    }
                });
                log('‚úÖ Microfone obtido', 'success');
            } catch (err) {
                log(`‚ùå Microfone bloqueado: ${err.message}`, 'error');
                throw err;
            }

            audioContext = new AudioContext({ sampleRate: TARGET_SAMPLE_RATE }); // ‚úÖ 24kHz
            await audioContext.resume();
            log(`‚úÖ AudioContext @ ${audioContext.sampleRate}Hz`, 'success');

            const source = audioContext.createMediaStreamSource(mediaStream);
            const bufferSize = 4096;
            scriptProcessor = audioContext.createScriptProcessor(bufferSize, 1, 1);

            let buffer = [];

            scriptProcessor.onaudioprocess = (e) => {
                const inputData = e.inputBuffer.getChannelData(0);

                for (let i = 0; i < inputData.length; i++) {
                    buffer.push(inputData[i]);

                    if (buffer.length >= CAPTURE_CHUNK_SIZE) {
                        // ‚úÖ Convers√£o PCM16 corrigida
                        const pcm16 = new Int16Array(CAPTURE_CHUNK_SIZE);
                        for (let j = 0; j < CAPTURE_CHUNK_SIZE; j++) {
                            const s = Math.max(-1, Math.min(1, buffer[j]));
                            pcm16[j] = s * (s < 0 ? 0x8000 : 0x7FFF);
                        }

                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(pcm16.buffer);
                            audioSentCount++;
                        }

                        buffer = [];
                    }
                }
            };

            source.connect(scriptProcessor);
            scriptProcessor.connect(audioContext.destination);

            log('‚úÖ Sistema de √°udio COMPLETO!', 'success');
        }

        // ‚úÖ AUDIO PLAYBACK - INT16 -> FLOAT32
        async function playAudio(arrayBuffer) {
            // 1. Inicializa contexto de playback se necess√°rio
            if (!playbackContext) {
                playbackContext = new AudioContext({ sampleRate: TARGET_SAMPLE_RATE });
                await playbackContext.resume();
                playbackScheduledTime = playbackContext.currentTime;
                log(`üîä Playback @ ${playbackContext.sampleRate}Hz (Convertendo Int16 -> Float32)`, 'info');
            }

            // 2. Interpreta os bytes brutos como PCM de 16 bits (Int16)
            // O servidor manda bytes: [Low, High, Low, High...]
            const pcm16Data = new Int16Array(arrayBuffer);

            // 3. Cria o vetor de Float32 para o Web Audio API
            const float32Data = new Float32Array(pcm16Data.length);

            // 4. CONVERS√ÉO EXPLICITA (Matem√°tica)
            // Transforma de -32768..+32767 para -1.0..+1.0
            for (let i = 0; i < pcm16Data.length; i++) {
                float32Data[i] = pcm16Data[i] / 32768.0;
            }

            // Monitoramento de Qualidade (usando dados convertidos)
            analyzeAudioQuality(float32Data.buffer);

            // 5. Cria o Buffer de √Åudio
            const audioBuffer = playbackContext.createBuffer(
                1, // Mono
                float32Data.length, // Tamanho
                TARGET_SAMPLE_RATE // Sample Rate do Gemini (24000)
            );

            // 6. Preenche o canal com os dados convertidos
            audioBuffer.getChannelData(0).set(float32Data);

            // 7. Toca o √°udio sem gaps (Fileira de reprodu√ß√£o)
            const source = playbackContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(playbackContext.destination);

            // L√≥gica para evitar sobreposi√ß√£o
            const currentTime = playbackContext.currentTime;
            if (playbackScheduledTime < currentTime) {
                playbackScheduledTime = currentTime;
            }

            source.start(playbackScheduledTime);

            // Atualiza o tempo para o pr√≥ximo peda√ßo
            playbackScheduledTime += audioBuffer.duration;
        }

        // ============ MAIN FUNCTIONS ============
        async function startEVA() {
            const cpf = document.getElementById('cpfInput').value;
            if (!cpf || cpf.length < 11) {
                alert('Digite um CPF v√°lido!');
                return;
            }

            log('üöÄ INICIANDO EVA (MODO OTIMIZADO)', 'success');
            startTime = Date.now();

            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;

            try {
                currentState = 'connecting';
                await connectWebSocket();

                const registerMsg = { type: 'register', cpf: cpf };
                ws.send(JSON.stringify(registerMsg));
                log('üì§ REGISTER enviado', 'info');

                await new Promise(resolve => setTimeout(resolve, 2000));

                const sessionID = 'web-' + Date.now();
                const callMsg = { type: 'start_call', cpf: cpf, session_id: sessionID };
                ws.send(JSON.stringify(callMsg));
                log('üì§ START_CALL enviado', 'info');

                await new Promise(resolve => setTimeout(resolve, 2000));

                await initializeAudio();

                isActive = true;
                currentState = 'active';
                log('‚úÖ EVA PRONTA! üíö', 'success');

            } catch (err) {
                log(`‚ùå ERRO: ${err.message}`, 'error');
                currentState = 'error';
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
        }

        function stopEVA() {
            log('üõë Parando EVA...', 'warning');
            if (ws) {
                ws.send(JSON.stringify({ type: 'hangup' }));
                ws.close();
            }
            cleanup();
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        function cleanup() {
            isActive = false;
            startTime = null;

            if (mediaStream) {
                mediaStream.getTracks().forEach(t => t.stop());
                mediaStream = null;
            }

            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            if (playbackContext) {
                playbackContext.close();
                playbackContext = null;
            }

            ws = null;
            audioSentCount = 0;
            audioReceivedCount = 0;
            currentState = 'idle';
            jitterBuffer = [];
            jitterBufferReady = false;
            snrHistory = [];
            volumeHistory = [];

            updateUI();
            log('‚úÖ Cleanup completo', 'success');
        }

        // Update UI periodically
        setInterval(updateUI, 1000);
        updateUI();

        log('üî¨ Debug Monitor OTIMIZADO inicializado', 'success');
        log('‚ú® Servidor envia Float32 direto | 24kHz | Buffer 9600 | Jitter', 'info');
    </script>
</body>

</html>